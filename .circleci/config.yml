version: 2.1
# CircleCi Build Config for CloudState

# use this orb to notify slack License:MIT
orbs:
  slack: circleci/slack@3.4.2
  pagerduty: amanjain97/pagerduty@0.1.5

commands:
  setup_sbt:
    description: "Set up SBT"
    parameters:
      version:
        type: string
        default: "1.3.3"
    steps:
      - run:
          name: Install SBT
          command: |
            curl -L -o sbt-<< parameters.version >>.deb https://dl.bintray.com/sbt/debian/sbt-<< parameters.version >>.deb
            sudo dpkg -i sbt-<< parameters.version >>.deb
            rm sbt-<< parameters.version >>.deb

  save_sbt_cache:
    description: "Save SBT cache"
    steps:
      - save_cache:
          key: sbt-cache-23
          paths:
            - "~/.ivy2/cache"
            - "~/.sbt"
            - "~/.coursier"

  cs_authenticate_test:
    parameters:
      target_env:
        type: string
        default: "dev"
    steps:
      - run:
          name: Curl authenticate
          command: |
            target=<< parameters.target_env >>
            if [[ "${target}" == "prod" ]]; then
              url=api.cloudstate.com
            elif [[ "${target}" == "stage" ]]; then
              url=api.lbcs.io
            else
              url=api.lbvs.dev
            fi
            set -x
            url_auth_path=cloudstateengine.lightbend.com/v1alpha/users%3Aauthenticate
            curl --fail -s -H 'Content-Type: application/json' https://"${url}"/"${url_auth_path}" -d \
              "{password: {\"email_or_friendly_name\":\"cloudstate-dev@lightbend.com\", \"password\":\"${CS_DEV_PASSWORD}\"}}"


jobs:
  native-image-it-test:
    machine: true
    resource_class: large
    description: "native image tck tests"
    steps:
      - checkout
      - setup_sbt
      - run: |
          sbt -Dconfig.resource=native-image.conf \
              'set concurrentRestrictions in Global += Tags.limitAll(1)' \
              'set scalafmtOnCompile := false' \
              'dockerBuildNativeDevMode publishLocal' \
              tck/it:test
      - save_sbt_cache

  prod-authenticate-test:
    docker:
      - image: circleci/buildpack-deps:focal-curl
    description: "Prod Authentication Test"
    steps:
      - cs_authenticate_test:
          target_env: "prod"

  stage-authenticate-test:
    docker:
      - image: circleci/buildpack-deps:focal-curl
    description: "Stage Authentication Test"
    steps:
      - cs_authenticate_test:
          target_env: "stage"
      - slack/status:
          channel: cloudstate-notifications
          success_message: Successful authentication on stage
          failure_message: Unable to authenticate on stage environment
          # mentions: "@edc,@srikanth"
          # fail_only: true
          only_for_branches: master,cron-test
      - pagerduty/notify-on-failure:
          escalation_policy: ""
          from_account: "srikanth.koneru@lightbend.com"
          incident_description: Unable to authentticate on stage environment
          incident_key:  "AUTHENTICATION_FAILED_ON_STAGE"
          incident_title: $CIRCLE_JOB failed
          only_for_branches: master, cron-test
          priority: ""
          service: "cloudstate-test"
          urgency: low


workflows:
  version: 2

  native-image-tests:
    jobs:
      - native-image-it-test:
          filters:
            branches:
              ignore: /.*/

  authetnticatre-state-test2:
    jobs:
      - stage-authenticate-test:
          filters:
            branches:
              only:
                - cron-test


  authenticate-stage-test:
    triggers:
      - schedule:
          cron: "5 * * * *"
          filters:
            branches:
              only:
                - master
                - cron-test
    jobs:
      - stage-authenticate-test

